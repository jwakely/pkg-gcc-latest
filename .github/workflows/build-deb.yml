# A workflow to build the deb package

name: Generate gcc-latest package for Ubuntu

on:
  # This job must only be run when changes are pushed to the master branch!
  push:
    branches: [ master ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  generate-deb-pkg:
    runs-on: ubuntu-latest

    steps:
    - name: Clone repo
      uses: actions/checkout@v6
      with:
        ref: ${{ env.BRANCH }}

    - name: Install prerequisites
      run: |
        sudo apt-get -q -y install build-essential curl m4 podman w3m

    - name: Build
      run: |
        buildver=$(cat BUILDVER)
        eval $(./build.sh $buildver info | sed '1,/tarfile/d')
        tar xf ${basename}.tar.*
        cd $basename
        ./contrib/download_prerequisites
        mkdir ../objdir
        cd ../objdir
        ../$basename/configure --prefix=/opt/gcc-latest --enable-languages=c,c++ --disable-bootstrap --disable-multilib --disable-libvtv --with-system-zlib --without-isl --enable-multiarch --enable-libstdcxx-debug
        make -j $(getconf _NPROCESSORS_ONLN)
        PKGNAME=gcc-latest_$BASE_VER-${DATE}git${REV}
        make install DESTDIR=/tmp/$PKGNAME
        DEBIAN_DIR=/tmp/$PKGNAME/DEBIAN
        mkdir $DEBIAN_DIR
        m4 -P -DVERSION=$BASE_VER -DSNAPINFO=${DATE}git${REV} control.m4 > $DEBIAN_DIR/control
        m4 -P -DVERSION=$BASE_VER postinst.m4 > $DEBIAN_DIR/postinst
        m4 -P -DVERSION=$BASE_VER postrm.m4 > $DEBIAN_DIR/postrm
        chmod 0755 $DEBIAN_DIR/postinst $DEBIAN_DIR/postrm
        cd /tmp && dpkg-deb --build $PKGNAME
        sudo apt-get -q -y install /tmp/$PKGNAME.deb
        sudo apt-get -q -y remove gcc-latest
        test ! -d /opt/gcc-latest
        git checkout gh-pages
        make index.html DATE=$DATE GITREV=$REV
        mv index.html $PKGNAME.deb static-pages/

    # Make the HTML pages available to the deploy job below.
    - name: Upload artifacts
      uses: actions/upload-pages-artifact@v4
      with:
        path: static-pages/

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: generate-deb-pkg
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
